import api.gigachat_api

class GeneratePrompt:
    async def generate_prompt_for_image(self, user_request: str, nko_information: str, giga: api.gigachat_api.GigaChatAPI) -> str:
        # Формируем системный промпт в зависимости от наличия информации об НКО
        base_system_prompt = """
        Ты профессиональный ассистент для создания детализированных промптов для генерации изображений. 
        Твоя задача - преобразовать короткий запрос пользователя в подробное, художественное описание на английском языке.

        Правила преобразования:
        1. Добавь конкретные детали: стиль (фотография, цифровое искусство, картина маслом и т.д.)
        2. Укажи освещение (естественное, студийное, драматическое и т.д.)
        3. Опиши композицию (крупный план, общий план, ракурс)
        4. Добавь детали о цветовой палитре и текстурах
        5. Укажи настроение и атмосферу
        6. Если уместно - добавь контекст окружения
        """
    
        # Добавляем информацию об НКО если она есть
        if nko_information and nko_information != "None":
            nko_context = f"""
        7. ОБЯЗАТЕЛЬНО учитывай контекст некоммерческой организации: {nko_information}
            - Отражай ценности и миссию организации в описании
            - Подбирай соответствующую тематику и настроение
            - Учитывай целевую аудиторию организации
            """
            system_prompt = base_system_prompt + nko_context
        else:
            system_prompt = base_system_prompt

        system_prompt += """
        Примеры преобразования:
        Пользователь: "кот на кухне"
        Результат: "Photorealistic black cat sleeping on a modern kitchen counter, warm morning light streaming through window, detailed fur texture, cozy home atmosphere, 4k resolution"

        Пользователь: "фантастический город"
        Результат: "Futuristic cityscape at sunset, towering skyscrapers with neon lights, flying vehicles between buildings, cyberpunk style, highly detailed digital art, cinematic lighting"

        Важные требования:
        - Отвечай ТОЛЬКО готовым промптом на английском языке
        - Не добавляй пояснения или комментарии
        - Промпт должен быть 1-2 предложения
        - Используй vivid descriptive language
        """

        # Формируем пользовательское сообщение
        if nko_information and nko_information != "None":
            user_message = f"""
            Исходный запрос пользователя: {user_request}
            Контекст НКО: {nko_information}
        
            Создай улучшенный промпт для генерации изображения, учитывая контекст некоммерческой организации:
            """
        else:
            user_message = f"""
            Исходный запрос пользователя: {user_request}
        
            Создай улучшенный промпт для генерации изображения:
            """
    
        # Используем GigaChatAPI для генерации промпта
        enhanced_prompt = await giga.generate_text(
            request=user_message
        )
    
        return enhanced_prompt.strip()
    
    async def generate_nko_description(self, short_nko_description: str, giga: api.gigachat_api.GigaChatAPI) -> str:
        """
        Создает подробное описание НКО на основе краткого описания.
    
        Args:
            short_nko_description: Краткое описание НКО
            giga: API для работы с GigaChat
        
        Returns:
            str: Подробное описание НКО на русском языке
        """
    
        system_prompt = """
        Ты профессиональный ассистент для создания подробных описаний некоммерческих организаций (НКО).
        Твоя задача - расширить краткое описание НКО в развернутое, информативное описание на русском языке.

        Правила создания описания:
        1. Опиши основные цели и миссию организации
        2. Укажи возможные направления деятельности (если применимо)
        3. Опиши целевую аудиторию или благополучателей
        4. Добавь информацию о ценностях и принципах работы
        5. Укажи возможную социальную значимость

        ВАЖНЫЕ ОГРАНИЧЕНИЯ:
        - НЕ придумывай конкретные факты, цифры, названия проектов
        - НЕ добавляй информацию, которой нет в исходном описании
        - Используй только общие формулировки, вытекающие из краткого описания
        - Описание должно быть реалистичным и соответствовать типу организации

        Примеры преобразования:
        Краткое описание: "Экологическая организация по защите океанов"
        Результат: "Экологическая некоммерческая организация, специализирующаяся на защите морских экосистем и океанических вод. Основные направления деятельности включают сохранение биоразнообразия океанов, борьбу с загрязнением водных ресурсов, защиту морских животных. Организация ориентирована на просвещение общества о важности сохранения океанической среды и привлечение внимания к экологическим проблемам морских пространств."

        Краткое описание: "Фонд помощи детям с онкологическими заболеваниями"
        Результат: "Благотворительный фонд, оказывающий поддержку детям с онкологическими заболеваниями и их семьям. Основная деятельность направлена на организацию медицинской помощи, психологическую поддержку пациентов и родственников, приобретение необходимых медикаментов и оборудования. Фонд стремится улучшить качество жизни детей в процессе лечения и способствовать их успешной реабилитации."

        Требования к ответу:
        - Отвечай ТОЛЬКО развернутым описанием на русском языке
        - Не добавляй пояснения или комментарии
        - Описание должно быть 3-5 предложений
        - Сохраняй официально-деловой стиль
        - Не используй маркеры списков
        """

        user_message = f"""
        Краткое описание НКО: {short_nko_description}
    
        Создай развернутое описание этой некоммерческой организации:
        """
    
        # Используем GigaChatAPI для генерации описания
        detailed_description = await giga.generate_text(
            request=user_message
        )
    
        return detailed_description.strip()
    
    async def generate_content_prompt(self, user_text: str, style: str, nko_information: str) -> str:
        """
        Формирует промпт для нейросети на основе пользовательского запроса.
    
        Args:
            user_text: Текст запроса от пользователя
            style: Стиль контента (формальный, неформальный, креативный и т.д.)
            nko_information: Информация об НКО
        
        Returns:
            str: Готовый промпт для нейросети
        """
    
        # Определяем тип запроса по ключевым словам
        user_text_lower = user_text.lower()
    
        # Базовый промпт с учетом стиля и НКО
        base_context = f"Стиль изложения: {style}."
        if nko_information and nko_information != "None":
            base_context += f" Учитывай контекст некоммерческой организации: {nko_information}"
    
        # Определяем тип контента и формируем специфичные инструкции
        if any(word in user_text_lower for word in ['пост', 'публикац', 'сообщен', 'vk', 'вконтакте', 'соцсет', 'соц сет']):
            content_type_instructions = """
            Создай качественный пост для социальных сетей со следующей структурой:
            - Привлекающий внимание заголовок/вступление
            - Основной текст с полезной информацией
            - Призыв к действию или вопрос для вовлечения аудитории
            - 5-10 релевантных хэштегов в конце
        
            Требования:
            - Текст должен быть живым и engaging
            - Используй эмодзи где это уместно
            - Абзацы не более 3-4 строк
            - Хэштеги должны быть релевантными тематике
            """
        
        elif any(word in user_text_lower for word in ['контент план', 'контент-план', 'план публикац', 'расписан']):
            content_type_instructions = """
            Составь подробный контент-план со следующей структурой:
            - Общая концепция и цели контента
            - Темы для 7-14 публикаций с описанием
            - Рекомендации по форматам (текст, фото, видео и т.д.)
            - Предложения по времени публикации
            - Метрики для оценки эффективности
        
            Требования:
            - План должен быть практичным и реализуемым
            - Учитывай сезонность и актуальные тренды
            - Включи разнообразие форматов
            """
        
        elif any(word in user_text_lower for word in ['иде', 'предлож', 'вариант']):
            if any(word in user_text_lower for word in ['визуал', 'изображен', 'картинк', 'фото', 'график']):
                content_type_instructions = """
                Предложи 5-7 креативных идей для визуального контента:
                - Опиши концепцию каждой идеи
                - Укажите возможные стили и цветовые палитры
                - Предложи варианты композиции
                - Добавь рекомендации по реализации
            
                Требования:
                - Идеи должны быть разнообразными и практичными
                - Учитывай современные тренды в дизайне
                - Ориентируйся на целевую аудиторию
                """
            else:
                content_type_instructions = """
                Предложи 7-10 креативных идей по запросу пользователя:
                - Детально опиши каждую идею
                - Укажите возможные форматы реализации
                - Добавь рекомендации по развитию идеи
                - Предложи варианты адаптации под разные каналы
            
                Требования:
                - Идеи должны быть конкретными и реализуемыми
                - Учитывай ресурсы некоммерческой организации
                - Ориентируйся на практическую пользу
                """
        else:
            content_type_instructions = """
            Подробно помоги пользователю с его запросом:
            - Развернуто ответь на вопрос
            - Предложи практические рекомендации
            - Учитывай контекст некоммерческой деятельности
            - Добавь примеры и кейсы где это уместно
            """
    
        # Формируем финальный промпт
        final_prompt = f"""
        {base_context}
    
        {content_type_instructions}
    
        Запрос пользователя: {user_text}
    
        Дополнительные требования:
        - Отвечай на русском языке
        - Будь конкретным и практичным
        - Используй структурированный подход
        - Предлагай реализуемые решения
        """
    
        return final_prompt.strip()